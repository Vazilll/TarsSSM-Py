"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Ğ¢ĞĞ Ğ¡ v3 â€” Colab Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’Ğ«Ğ™ ĞŸĞ ĞĞ“ĞĞ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ÑĞµÑ… Ñ„Ğ°Ğ· Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸.
Ğ’Ñ€ĞµĞ¼Ñ: ~15-30 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ½Ğ° Colab A100 / T4 / L4

Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ¯:
  1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Colab Ğ½Ğ¾ÑƒÑ‚Ğ±ÑƒĞº (Runtime â†’ A100/T4/L4 GPU)
  2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ TarsSSM-Py Ğ² /content/TarsSSM-Py/
  3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚: !python colab_test.py

  ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° (Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· git):
     !git clone https://github.com/<Ğ²Ğ°Ñˆ-Ñ€ĞµĞ¿Ğ¾>/TarsSSM-Py.git
     %cd TarsSSM-Py
     !python colab_test.py

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import sys
import time
import subprocess
from pathlib import Path

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ROOT = Path(__file__).resolve().parent
os.chdir(ROOT)
sys.path.insert(0, str(ROOT))

IS_COLAB = "COLAB_GPU" in os.environ or "google.colab" in str(os.environ.get("SHELL", ""))
IS_KAGGLE = "KAGGLE_DATA_DIR" in os.environ

PYTHON = sys.executable

print("â•" * 65)
print("  Ğ¢ĞĞ Ğ¡ v3 â€” Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’Ğ«Ğ™ ĞŸĞ ĞĞ“ĞĞ (Quick Mode)")
print("â•" * 65)
print()

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° GPU
try:
    import torch
    if torch.cuda.is_available():
        gpu = torch.cuda.get_device_name(0)
        vram = torch.cuda.get_device_properties(0).total_memory / 1024**3
        print(f"  ğŸ® GPU:  {gpu} ({vram:.1f} GB)")
    else:
        print("  âš ï¸  GPU Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼")
except ImportError:
    print("  ğŸ“¦ PyTorch Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ â€” Ğ±ÑƒĞ´ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ² Ğ¤Ğ°Ğ·Ğµ 0")
print()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Ğ—Ğ°Ğ¿ÑƒÑĞº mega_train.py --quick
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# --quick Ğ´ĞµĞ»Ğ°ĞµÑ‚:
#   Ğ¤Ğ°Ğ·Ğ° 2: ReflexClassifier     10 ÑĞ¿Ğ¾Ñ… (Ğ²Ğ¼ĞµÑÑ‚Ğ¾ 100)
#   Ğ¤Ğ°Ğ·Ğ° 3: MinGRU LM            3 ÑĞ¿Ğ¾Ñ…Ğ¸, dim=256, 4 ÑĞ»Ğ¾Ñ
#   Ğ¤Ğ°Ğ·Ğ° 4: Mamba-2              1 ÑĞ¿Ğ¾Ñ…Ğ° Ã— 4 Ğ¿Ğ¾Ğ´-Ñ„Ğ°Ğ·Ñ‹, d_model=256, 4 ÑĞ»Ğ¾Ñ, max_samples=500
#   Ğ¤Ğ°Ğ·Ğ° 5: ĞšĞ²Ğ°Ğ½Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ 1.58-bit 1 ÑĞ¿Ğ¾Ñ…Ğ°
#   Ğ¤Ğ°Ğ·Ğ° 8: Whisper               1 ÑĞ¿Ğ¾Ñ…Ğ°, 500 samples
#   Ğ¤Ğ°Ğ·Ğ° 9: Piper                 100 ÑĞ¿Ğ¾Ñ…, 200 samples

print("  ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° Ğ² quick mode...")
print("  â±  ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: ~15-30 Ğ¼Ğ¸Ğ½ÑƒÑ‚")
print()
print("  Ğ¤Ğ°Ğ·Ñ‹:")
print("    0. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (pip)")
print("    1. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Wiki + HuggingFace)")
print("    2. Ğ ĞµÑ„Ğ»ĞµĞºÑÑ‹ (ReflexClassifier, 10 ÑĞ¿Ğ¾Ñ…)")
print("    3. MinGRU LM (dim=256, 4 ÑĞ»Ğ¾Ñ, 3 ÑĞ¿Ğ¾Ñ…Ğ¸)")
print("    4. Mamba-2 (d=256, 4 ÑĞ»Ğ¾Ñ, 1 ÑĞ¿Ğ¾Ñ…Ğ° Ã— 4 Ñ„Ğ°Ğ·Ñ‹)")
print("    5. ĞšĞ²Ğ°Ğ½Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ 1.58-bit (1 ÑĞ¿Ğ¾Ñ…Ğ°)")
print("    6. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°")
print("    7. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ (Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ)")
print("    8. Whisper STT (LoRA, 1 ÑĞ¿Ğ¾Ñ…Ğ°)")
print("    9. Piper TTS (100 ÑĞ¿Ğ¾Ñ…)")
print("   10. ĞšĞ²Ğ°Ğ½Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ… ONNX")
print("   11. Instruction Tuning (2 ÑĞ¿Ğ¾Ñ…Ğ¸)")
print()
print("â”€" * 65)

t0 = time.time()

result = subprocess.run(
    [PYTHON, "mega_train.py", "--quick"],
    cwd=str(ROOT),
)

elapsed = time.time() - t0
minutes = elapsed / 60

print()
print("â•" * 65)
if result.returncode == 0:
    print(f"  âœ… Ğ¢Ğ•Ğ¡Ğ¢ ĞŸĞ ĞĞ™Ğ”Ğ•Ğ Ğ·Ğ° {minutes:.1f} Ğ¼Ğ¸Ğ½ÑƒÑ‚!")
    print()
    print("  Ğ’ÑĞµ Ñ„Ğ°Ğ·Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹. ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ² models/tars_v3/")
    print("  ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ: python colab_train.py")
else:
    print(f"  âš ï¸  Ğ¢ĞµÑÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»ÑÑ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸ (ĞºĞ¾Ğ´ {result.returncode})")
    print(f"     Ğ’Ñ€ĞµĞ¼Ñ: {minutes:.1f} Ğ¼Ğ¸Ğ½ÑƒÑ‚")
    print()
    print("  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ mega_train.log Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹:")
    print("  !cat mega_train.log | tail -50")
print("â•" * 65)
